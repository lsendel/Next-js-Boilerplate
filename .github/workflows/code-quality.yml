name: Code Quality

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch:

permissions:
  contents: read
  pull-requests: write
  checks: write

jobs:
  lint:
    name: ESLint
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: Checkout code
        uses: actions/checkout@v5

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm

      - name: Install dependencies
        run: npm ci

      - name: Run ESLint
        run: npm run lint -- --format=json --output-file=eslint-report.json || true

      - name: Annotate code with lint results
        uses: ataylorme/eslint-annotate-action@v3
        if: always()
        with:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          report-json: eslint-report.json
          only-pr-files: true
          fail-on-error: false
          fail-on-warning: false

      - name: Upload ESLint report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: eslint-report
          path: eslint-report.json
          retention-days: 30

      - name: Check for errors
        run: |
          ERRORS=$(cat eslint-report.json | jq '[.[] | select(.errorCount > 0)] | length')
          WARNINGS=$(cat eslint-report.json | jq '[.[] | select(.warningCount > 0)] | length')

          echo "Files with errors: $ERRORS"
          echo "Files with warnings: $WARNINGS"

          if [ "$ERRORS" -gt 0 ]; then
            echo "::error::Found linting errors in $ERRORS files"
            npm run lint
            exit 1
          fi

  prettier:
    name: Prettier Format Check
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout code
        uses: actions/checkout@v5

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm

      - name: Install dependencies
        run: npm ci

      - name: Run Prettier check
        run: npx prettier --check "src/**/*.{ts,tsx,js,jsx,json,css,md}" --log-level=warn

      - name: Generate format diff
        if: failure()
        run: |
          echo "## Prettier Format Issues" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Run \`npm run format\` to fix formatting issues:" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`bash" >> $GITHUB_STEP_SUMMARY
          echo "npm run format" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY

  typescript:
    name: TypeScript Type Check
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: Checkout code
        uses: actions/checkout@v5

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm

      - name: Install dependencies
        run: npm ci

      - name: Run TypeScript type check
        run: npm run check:types

      - name: Type coverage report
        if: always()
        run: |
          echo "## TypeScript Type Check" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Type check: ${{ job.status }}" >> $GITHUB_STEP_SUMMARY

  code-duplication:
    name: Code Duplication Detection
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout code
        uses: actions/checkout@v5

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm

      - name: Install jscpd
        run: npm install -g jscpd

      - name: Run code duplication check
        id: jscpd
        run: |
          jscpd src --threshold 3 --format javascript,typescript --reporters json,console --output ./jscpd-report || true

      - name: Upload duplication report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: code-duplication-report
          path: jscpd-report
          retention-days: 30

      - name: Comment duplication summary
        if: github.event_name == 'pull_request' && always()
        run: |
          if [ -f "jscpd-report/jscpd-report.json" ]; then
            DUPLICATES=$(cat jscpd-report/jscpd-report.json | jq '.statistics.total.percentage' || echo "0")
            echo "Code duplication: $DUPLICATES%"

            if (( $(echo "$DUPLICATES > 5" | bc -l) )); then
              echo "::warning::Code duplication is $DUPLICATES% (threshold: 5%)"
            fi
          fi

  code-complexity:
    name: Code Complexity Analysis
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout code
        uses: actions/checkout@v5

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm

      - name: Install dependencies
        run: npm ci

      - name: Install complexity analyzer
        run: npm install -g complexity-report

      - name: Run complexity analysis
        run: |
          cr src --format json > complexity-report.json || true

      - name: Upload complexity report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: complexity-report
          path: complexity-report.json
          retention-days: 30

  quality-summary:
    name: Code Quality Summary
    runs-on: ubuntu-latest
    needs: [lint, prettier, typescript, code-duplication]
    if: always()

    steps:
      - name: Quality Summary
        run: |
          echo "## Code Quality Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Check | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| ESLint | ${{ needs.lint.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Prettier | ${{ needs.prettier.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| TypeScript | ${{ needs.typescript.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Duplication | ${{ needs.code-duplication.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "${{ needs.lint.result }}" == "failure" ] || [ "${{ needs.prettier.result }}" == "failure" ] || [ "${{ needs.typescript.result }}" == "failure" ]; then
            echo "⚠️ **Code quality checks failed!** Please fix the issues above." >> $GITHUB_STEP_SUMMARY
            exit 1
          else
            echo "✅ **All code quality checks passed**" >> $GITHUB_STEP_SUMMARY
          fi
